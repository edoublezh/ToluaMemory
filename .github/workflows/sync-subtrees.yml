name: Sync Subtrees

on:
  schedule:
    - cron: '0 2 * * *'   # æ¯å¤© 02:00 UTC
  workflow_dispatch:

permissions:
  contents: write   # è®© GITHUB_TOKEN æœ‰æ¨é€æƒé™

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ToluaMemory (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0            # éœ€è¦å®Œæ•´å†å²ï¼Œsubtree æ‰èƒ½å·¥ä½œ
          token: ${{ secrets.actionUse || github.token }}  # ä½ çš„ PAT ä¼˜å…ˆï¼›å¦åˆ™é€€å› GITHUB_TOKEN

      - name: Git identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"

      - name: Sync ToluaCode (tolua_runtime.git)
        run: |
          set -e
          PREFIX="ToluaCode"
          REPO="https://github.com/edoublezh/tolua_runtime.git"
          BRANCH="master"   # è‹¥ä¸Šæ¸¸æ˜¯ mainï¼Œè¯·æ”¹æˆ main

          # åˆ¤æ–­æ˜¯å¦å·²æœ‰ subtreeï¼ˆåœ¨å†å²ä¸­å­˜åœ¨ä»¥è¯¥ prefix çš„ subtree æäº¤ï¼‰
          if git rev-parse -q --verify "$(git subtree split --prefix="$PREFIX" 2>/dev/null)" >/dev/null; then
            echo "Subtree $PREFIX exists. Pullingâ€¦"
            git subtree pull --prefix="$PREFIX" "$REPO" "$BRANCH" --squash -m "ğŸ¤– chore($PREFIX): Sync from upstream"
          else
            echo "Subtree $PREFIX not found. Addingâ€¦"
            # ç›®å½•è‹¥å·²å­˜åœ¨ä½†ä¸æ˜¯ subtreeï¼Œä¼šå°è¯•åˆå¹¶ï¼›å¦‚å†²çªï¼Œè¯·å…ˆæŠŠç°æœ‰ç›®å½•æ¸…ç©ºæˆ–ç¡®ä¿ä¸ä¸Šæ¸¸ä¸€è‡´
            git subtree add --prefix="$PREFIX" "$REPO" "$BRANCH" --squash -m "ğŸ¤– chore($PREFIX): Init from upstream"
          fi

      - name: Sync ToluaUnity (tolua.git)
        run: |
          set -e
          PREFIX="ToluaUnity"
          REPO="https://github.com/edoublezh/tolua.git"
          BRANCH="master"   # è‹¥ä¸Šæ¸¸æ˜¯ mainï¼Œè¯·æ”¹æˆ main

          if git rev-parse -q --verify "$(git subtree split --prefix="$PREFIX" 2>/dev/null)" >/dev/null; then
            echo "Subtree $PREFIX exists. Pullingâ€¦"
            git subtree pull --prefix="$PREFIX" "$REPO" "$BRANCH" --squash -m "ğŸ¤– chore($PREFIX): Sync from upstream"
          else
            echo "Subtree $PREFIX not found. Addingâ€¦"
            git subtree add --prefix="$PREFIX" "$REPO" "$BRANCH" --squash -m "ğŸ¤– chore($PREFIX): Init from upstream"
          fi

      - name: Push changes (if any)
        run: |
          # é¿å…ç©ºæ¨é€æŠ¥é”™
          if ! git diff --quiet HEAD; then
            git push
          else
            echo "No changes to push."
          fi
