name: Sync Submodules

on:
  schedule:
    - cron: '0 2 * * *'      # æ¯å¤© 02:00 UTC
  workflow_dispatch:
  repository_dispatch:
    types: [bump-submodules]  # æ¥æ”¶å­ä»“åº“é€šçŸ¥

permissions:
  contents: write

concurrency:
  group: sync-submodules
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ToluaMemory
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          # å¦‚éœ€ç”¨ä½ è‡ªå»º PAT æ¨å›ï¼Œå¯åŠ ï¼š
          # token: ${{ secrets.actionUse }}

      - name: Ensure submodule branch tracking (master)
        run: |
          need_commit=0
          if ! git config -f .gitmodules submodule.ToluaCode.branch >/dev/null; then
            git config -f .gitmodules submodule.ToluaCode.branch master
            need_commit=1
          fi
          if ! git config -f .gitmodules submodule.ToluaUnity.branch >/dev/null; then
            git config -f .gitmodules submodule.ToluaUnity.branch master
            need_commit=1
          fi
          if [ "$need_commit" -eq 1 ]; then
            git add .gitmodules
            git -c user.name="github-actions[bot]" \
                -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
                commit -m "chore: set submodule branch tracking to master"
          fi

      - name: Sync & Update submodules to latest (no merge)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git submodule sync --recursive
          # å…³é”®ï¼šä½¿ç”¨ --remote --forceï¼Œè€Œä¸æ˜¯ --merge
          git submodule update --init --recursive --remote --force

          if ! git diff --quiet --submodule=diff; then
            git add ToluaCode ToluaUnity .gitmodules
            git commit -m "ğŸ¤– bump submodules to latest"
            git push
          else
            echo "No submodule changes."
          fi
